import { ActionInputsBuilder } from './utils'
import { generateStatusUrl, status } from '../src/api/status'
import { UploadApiResponseObject } from '../src/types/action'
import * as statusUtils from '../src/api/status'
import sinon, { createSandbox } from 'sinon'

const sandbox = createSandbox()
const BOM_RECORD_ID = 'sample-bom-record-id'

describe('Status', () => {
  let actionInputsBuilder = new ActionInputsBuilder()

  it('Should generate a URL with the correct search parameters', () => {
    let actionInputs = actionInputsBuilder.build()

    const statusUrl = generateStatusUrl(actionInputs, BOM_RECORD_ID)
    let expectedUrl = new URL('/api/sbom/core/upload/status', actionInputs.secrets.snInstanceUrl)
    let urlSearchParams = new URLSearchParams()
    urlSearchParams.append('bomRecordId', BOM_RECORD_ID)
    expectedUrl.search = urlSearchParams.toString()
    expect(statusUrl.href).toBe(expectedUrl.href)
  })

  // it('Should perform a status poll', async () => {
  //   let actionInputs = actionInputsBuilder.build()
  //   let uploadOperationResponseObject: UploadApiResponseObject = {
  //     data: {
  //       result: {
  //         status: 'success',
  //         message: 'Queued for processing.',
  //         bomRecordId: 'sample-bom-record-id',
  //       }
  //     }, documentName: 'sample-document' }
  //
  //   sandbox.stub(statusUtils, '_performStatus').resolves({
  //     result: {
  //       bomRecordId: BOM_RECORD_ID,
  //       uploadStatus: 'processed',
  //       additionalInfoStatus: 'importing_data',
  //       buildId: 'xyz123'
  //     }
  //   })
  //
  //   let results = await status(actionInputs, uploadOperationResponseObject)
  // })
})
